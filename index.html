<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Snake Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="snake.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body id="the-body">
    <div class="container-fluid " id="full-body">
        <div class="row wrapper justify-content-center align-items-center ">
            <!-- <div style="position: fixed;top: 10%;left:20%;color:#f3f3f3;">
            <h3 id="score">Score : 0</h3>
        </div> -->
            <div class="gamebox p-0">
                <table id="box">

                </table>
            </div>
            <!-- <div style="position: fixed;top: 10%;right:10%;color:#f3f3f3;">
            <h3 id="H-score">Highest Score : 0</h3>
        </div> -->
        </div>
        <button id="exit" class="d-none btn fs-3 position-fixed d-inline top-0 end-0 p-0" onclick="closeFullscreen()"><i
                class="fas fa-compress text-muted"></i> <br> <span style="font-size: 15px;">Exit Full
                Screen</span></button>
        <div class="modal fade show" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="10" aria-labelledby="staticBackdropLabel" aria-hidden="true" style="display: block;">
            <div class="modal-dialog modal-dialog-centered rounded-3">
                <div class="modal-content bg-dark border-0"
                    style="box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);">
                    <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                    <div class="modal-body p-4 row justify-content-center align-items-center">
                        <div class="col-12 text-center mb-4" style="height:100px">
                            <img src="./snake.png" class="mx-auto logo" alt="">
                        </div>
                        <div class="col-12 mb-3">
                            <button onclick="requestAnimationFrame(main);"
                                class="btn mx-auto btn-success rounded-circle p-4 d-flex justify-content-center align-items-center"><i
                                    class="fas fa-play fs-2" id="change"></i> </button>
                        </div>
                        <div class="col-12 mb-3 text-center">

                            <input type="radio" class="btn-check" name="speed" id="option1" value="5" autocomplete="off"
                                checked>
                            <label class="btn btn-secondary" for="option1">Easy</label>

                            <input type="radio" class="btn-check" name="speed" id="option2" value="10"
                                autocomplete="off">
                            <label class="btn btn-secondary" for="option2">Medium</label>

                            <input type="radio" class="btn-check" name="speed" id="option4" value="15"
                                autocomplete="off">
                            <label class="btn btn-secondary" for="option4">Hard</label>
                        </div>
                        <div class="col-12">
                            <p class="text-muted text-center" style="font-size:12px">Click Or Press [SPACE] to Start
                                Game</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <script src="jquery.min.js"></script>
    <script>
        var elem = document.getElementById("full-body");
        /* View in fullscreen */
        function openFullscreen() {
            $("#exit").removeClass("d-none")
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                /* IE11 */
                elem.msRequestFullscreen();
            }
        }

        /* Close fullscreen */
        function closeFullscreen() {
            $("#exit").addClass("d-none");
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                /* IE11 */
                document.msExitFullscreen();
            }
        }

        $(document).ready(function () {
            openFullscreen();
        })
    </script>
    <script>
        let box = 20;
        let food = {
            x: 4,
            y: 6
        };
        let speed = 5;
        let lastframe = 0;
        let snake = Array({
            x: 11,
            y: 10
        });
        let dir = {
            x: 0,
            y: 0
        };
        let score = 0;
        let Hscore = 0;
        var keyclick = new Audio("./sound/click.wav");
        var music = new Audio("./sound/music.mp3");
        var gameover = new Audio("./sound/game-over.wav");
        var foodsound = new Audio("./sound/food.wav");

        $("input[name='speed']").on("change", function () {
            if ($("input[name='speed']").is(":checked")) {
                speed = $(this).val();
            }
        });

        function createBox(boxes) {
            for (let i = 1; i <= boxes; i++) {
                $("#box").append("<tr class='line' id='" + i + "'></tr>");
                for (let j = 1; j <= boxes; j++) {
                    $("#" + i).append("<td id='" + i + "-" + j + "'></td>");
                }
            }
        }
        createBox(box);

        $(document).on("swipe", function (e) {
            console.log(e);
        });

        function main(cframe) {
            $("#staticBackdrop").removeAttr("style");
            $("#change").removeClass("fa-play");
            $("#change").addClass("fa-redo");
            frame = requestAnimationFrame(main);
            // console.log(cframe);
            if ((cframe - lastframe) / 1000 < 1 / speed) {
                return;
            }
            lastframe = cframe;
            gameEngine();
        }

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function isCollapse(snakearr) {
            for (let j = 1; j < snake.length; j++) {
                if (snakearr[j].x === snakearr[0].x && snakearr[j].y === snakearr[0].y) {
                    return true;
                }
            }

            if (snake[0].x > 20 || snake[0].x < 1 || snake[0].y < 1 || snake[0].y > 20) {
                return true;
            }
        }

        function gameEngine() {
            // console.log("X : "+snake[0].x+" Y : "+snake[0].y);
            music.play();
            music.volume = 0.5;
            // Updateing Snake and Food
            if (localStorage.getItem("HighScore") == null) {
                localStorage.setItem("HighScore", Hscore);
            }
            if (isCollapse(snake)) {
                gameover.play();
                dir = {
                    x: 0,
                    y: 0
                };
                snake = [{
                    x: 11,
                    y: 10
                }];
                cancelAnimationFrame(frame);
                $("#staticBackdrop").attr("style", "display:block");

                if (score > localStorage.getItem("HighScore")) {
                    localStorage.setItem("HighScore", score)
                }
                score = 0;
                music.pause();
            }


            if (snake[0].x == food.x && snake[0].y == food.y) {
                snake.unshift({
                    x: snake[0].x + dir.x,
                    y: snake[0].y + dir.y
                });
                $("#" + food.x + "-" + food.y).removeClass("food");
                food = {
                    x: random(1, box),
                    y: random(1, box)
                }
                score += 10;
                foodsound.play();
            }

            for (let i = snake.length - 2; i >= 0; i--) {
                snake[i + 1] = {
                    ...snake[i]
                };
                $("#" + snake[i + 1].x + "-" + snake[i + 1].y).removeClass("snake-body snake-head");
            }

            snake[0].x += dir.x;
            snake[0].y += dir.y;

            // Placements of Food and Snake 
            if ($("#box > tr > td").hasClass("snake-body") == true) {
                $("#box").find(".snake-body").removeClass("snake-body")
                $("#box").find(".snake-head").removeClass("snake-head");
            }

            snake.forEach((e, index) => {
                // console.log(e.y)
                if (index == 0) {
                    $("#" + e.x + "-" + e.y).addClass("snake-body snake-head");
                } else {
                    $("#" + e.x + "-" + e.y).addClass("snake-body");
                }
            });
            $("#" + food.x + "-" + food.y).addClass("food");
            $("#score").html("Score : " + score);
            $("#H-score").html("Highest Score : " + localStorage.getItem("HighScore"));
        }



        // requestAnimationFrame(main);
        $(document).keydown(function (event) {
            dir = {
                x: 0,
                y: 0
            };
            keyclick.play();
            // console.log(event.key);
            switch (event.key) {
                case 'ArrowUp':
                    dir.x = -1;
                    dir.y = 0;
                    break;
                case 'ArrowDown':
                    dir.x = +1;
                    dir.y = 0;
                    break;
                case 'ArrowLeft':
                    dir.x = 0;
                    dir.y = -1;
                    break;
                case 'ArrowRight':
                    dir.x = 0;
                    dir.y = +1;
                    break;
                case ' ':
                    requestAnimationFrame(main);
                    break;
                case 'p':
                    cancelAnimationFrame(frame);
                    break;
                default:
                    break;
            }
        })
        var pageWidth = window.innerWidth || document.body.clientWidth;
        var treshold = Math.max(1, Math.floor(0.01 * (pageWidth)));
        var touchstartX = 0;
        var touchstartY = 0;
        var touchendX = 0;
        var touchendY = 0;

        var limit = Math.tan(45 * 1.5 / 180 * Math.PI);
        var gestureZone = document.getElementById('the-body');



        gestureZone.addEventListener('touchstart', function (event) {
            touchstartX = event.changedTouches[0].screenX;
            touchstartY = event.changedTouches[0].screenY;
        }, false);

        gestureZone.addEventListener('touchend', function (event) {
            touchendX = event.changedTouches[0].screenX;
            touchendY = event.changedTouches[0].screenY;
            handleGesture(event);
        }, false);



        function handleGesture(e) {

            var x = touchendX - touchstartX;
            var y = touchendY - touchstartY;
            var xy = Math.abs(x / y);
            var yx = Math.abs(y / x);

            if (Math.abs(x) > treshold || Math.abs(y) > treshold) {
                if (yx <= limit) {
                    if (x < 0) {

                        console.log("swipe left");
                        dir.x = 0;
                        dir.y = -1;
                    } else {

                        console.log("swipe right");
                        dir.x = 0;
                        dir.y = +1;
                    }
                }
                if (xy <= limit) {
                    if (y < 0) {
                        console.log("swipe up");
                        dir.x = -1;
                        dir.y = 0;
                    } else {
                        console.log("swipe down");
                        dir.x = +1;
                        dir.y = 0;
                    }
                }
            } else {
                console.log("tap");
                $('#label').html("tap");
                $('#label').css('display', 'inline');
                $('#label').fadeOut(1000);
            }
        }
    </script>
</body>

</html>